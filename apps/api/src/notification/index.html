<!DOCTYPE html>
<html>
  <head>
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" crossorigin="anonymous"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        margin: 20px;
      }
      .notification {
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f5f5f5;
        border-right: 4px solid #3498db;
        border-radius: 4px;
      }
      .notification-time {
        font-size: 12px;
        color: #888;
      }
      #notifications-container {
        max-width: 500px;
      }
      #connection-status {
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 15px;
      }
      .connected {
        background-color: #2ecc71;
        color: white;
      }
      .disconnected {
        background-color: #e74c3c;
        color: white;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ”” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
    <div id="connection-status" class="disconnected">ØºÙŠØ± Ù…ØªØµÙ„</div>
    <div id="notifications-container"></div>

    <script>
      // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
      const receivedNotifications = new Set();
      const notificationsContainer = document.getElementById('notifications-container');
      const connectionStatus = document.getElementById('connection-status');
      
      // ØªØ­Ø¯ÙŠØ¯ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userId = '5704dbf7-d88c-4a06-8747-ed51680e5e31';

      // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ namespace 'notifications' Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ userId ÙÙŠ Ø§Ù„Ù€ query
      const socket = io('http://localhost:5000/notifications', {
        query: { userId },
        reconnectionAttempts: 5,
        reconnectionDelay: 1000
      });

      // Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
      socket.on('connect', () => {
        console.log('âœ… Connected to WebSocket server');
        connectionStatus.textContent = 'Ù…ØªØµÙ„';
        connectionStatus.className = 'connected';
        
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø³Ù†Ø§ Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« subscribe_notifications Ù„Ø£Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ø§Ù„Ø¬ Ù‡Ø°Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      });

      // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      socket.on('notifications', data => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        if (!data.id || receivedNotifications.has(data.id)) {
          console.log('ğŸ”„ Duplicate notification skipped:', data.id);
          return;
        }
        
        console.log('ğŸ”” Notification Received:', data);
        receivedNotifications.add(data.id);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        displayNotification(data);
      });

      // Ø¹Ù†Ø¯ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
      socket.on('disconnect', () => {
        console.log('âŒ Disconnected from WebSocket server');
        connectionStatus.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        connectionStatus.className = 'disconnected';
      });

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        connectionStatus.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        connectionStatus.className = 'disconnected';
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
      function displayNotification(notification) {
        const div = document.createElement('div');
        div.className = 'notification';
        
        const timestamp = notification.timestamp ? new Date(notification.timestamp) : new Date();
        const formattedTime = formatTime(timestamp);
        
        div.innerHTML = `
          <div>${notification.message}</div>
          <div class="notification-time">${formattedTime}</div>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        notificationsContainer.insertBefore(div, notificationsContainer.firstChild);
      }

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
      function formatTime(date) {
        return date.toLocaleTimeString('ar-SA', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });
      }
    </script>
  </body>
</html>